# 데이터베이스 요구사항분석서

## 1. 요구사항 정의서

### ① 의사 테이블 (User)

**목적:** 의료진(의사, 관리자)의 로그인 정보 및 개인 정보를 저장하는 테이블입니다.

**필드:**
- 의사 코드 (User ID) - Primary Key (PK)
- 의사 이름 (Name)
- 의사 로그인 이메일 (Email)
- 의사 비밀번호 (Password)
- 의사 소속 병원 (Hospital)
- 의사 소속 부서 (Department)
- 의사 면허번호 (License Number)
- 의사 역할 (Role) - enum: 'doctor', 'admin'
- 프로필 이미지 경로 (Profile Image)
- 생성일시 (Created At)
- 수정일시 (Updated At)

**관계:** 
- 한 명의 의사는 여러 명의 환자를 담당할 수 있습니다. 따라서 의사 테이블과 환자 테이블은 1:N (One-to-Many) 관계입니다.
- 한 명의 의사는 여러 건의 진단 결과를 작성할 수 있습니다. 따라서 의사 테이블과 진단 테이블은 1:N (One-to-Many) 관계입니다.
- 한 명의 의사는 여러 개의 일정을 가질 수 있습니다. 따라서 의사 테이블과 일정 테이블은 1:N (One-to-Many) 관계입니다.

---

### ② 환자 테이블 (Patient)

**목적:** 환자의 기본 정보 및 상태를 저장하는 테이블입니다.

**필드:**
- 환자 코드 (Patient ID) - Primary Key (PK)
- 환자 이름 (Name)
- 환자 나이 (Age)
- 환자 성별 (Gender) - enum: '남성', '여성', '기타'
- 병실 번호 (Room Number)
- 의무기록번호 (Medical Record Number)
- 환자 상태 (Status) - enum: 'normal', 'pending', 'urgent'
- 담당 의사 코드 (Doctor ID) - Foreign Key (FK)
- 증상 (Symptoms)
- 삭제 여부 (Is Deleted)
- 삭제일시 (Deleted At)
- 생성일시 (Created At)
- 수정일시 (Updated At)

**관계:**
- 한 명의 환자는 여러 건의 진단 결과를 가질 수 있습니다. 따라서 환자 테이블과 진단 테이블은 1:N (One-to-Many) 관계입니다.
- 한 명의 환자는 여러 개의 일정을 가질 수 있습니다. 따라서 환자 테이블과 일정 테이블은 1:N (One-to-Many) 관계입니다.

---

### ③ 진단 결과 테이블 (Diagnosis)

**목적:** AI 모델(UNet + ResNet50)을 통해 분석된 흉부 X-Ray 이미지의 진단 결과를 저장하는 테이블입니다.

**필드:**
- 진단 코드 (Diagnosis ID) - Primary Key (PK)
- 환자 코드 (Patient ID) - Foreign Key (FK)
- 의사 코드 (Doctor ID) - Foreign Key (FK)
- 이미지 파일 경로 (Image URL)
- AI 분석 결과 (AI Analysis)
  - 신뢰도 (Confidence) - decimal
  - 발견 사항 (Findings) - Array
    - 질환명 (Condition) - String
    - 확률 (Probability) - decimal
    - 설명 (Description) - String
  - 권장 사항 (Recommendations) - Array[String]
  - AI 노트 (AI Notes) - String
  - Grad-CAM 이미지 경로 (GradCAM Path) - String
  - Grad-CAM++ 이미지 경로 (GradCAM Plus Path) - String
  - Layer-CAM 이미지 경로 (LayerCAM Path) - String
- 의사 검토 결과 (Review)
  - 요약 (Summary) - String
  - 소견 (Notes) - String
  - 검토 상태 (Status) - enum: 'pending', 'approved', 'rejected'
  - 검토일시 (Updated At) - Date
- 생성일시 (Created At)
- 수정일시 (Updated At)

**관계:**
- 한 건의 진단 결과는 한 명의 환자에 속합니다. 따라서 환자 테이블과 진단 테이블은 1:N (One-to-Many) 관계입니다.
- 한 건의 진단 결과는 한 명의 의사에 의해 작성됩니다. 따라서 의사 테이블과 진단 테이블은 1:N (One-to-Many) 관계입니다.
- 한 건의 일정은 한 건의 진단 결과와 연결될 수 있습니다. 따라서 진단 테이블과 일정 테이블은 1:1 (One-to-One) 관계입니다.

---

### ④ 일정 테이블 (Schedule)

**목적:** 의료진의 수술, 진료, X-Ray 검토 등 일정 정보를 저장하는 테이블입니다.

**필드:**
- 일정 코드 (Schedule ID) - Primary Key (PK)
- 일정 유형 (Type) - enum: 'surgery', 'appointment', 'xray', 'meeting', 'other'
- 환자 코드 (Patient ID) - Foreign Key (FK) - Null 가능 (xray, meeting, other 타입의 경우)
- 의사 코드 (Doctor ID) - Foreign Key (FK)
- 시작 일시 (Start Date Time) - datetime
- 종료 일시 (End Date Time) - datetime
- 장소 (Location) - String
- 일정 상태 (Status) - enum: 'scheduled', 'completed', 'cancelled', 'in-progress'
- 상태 텍스트 (Status Text) - String
- 우선순위 (Priority) - enum: 'low', 'medium', 'high', 'urgent'
- 연결된 진단 코드 (Linked Case ID) - Foreign Key (FK) - Null 가능
- 메모 (Notes) - String
- 삭제 여부 (Is Deleted)
- 삭제일시 (Deleted At)
- 생성일시 (Created At)
- 수정일시 (Updated At)

**관계:**
- 한 건의 일정은 한 명의 의사에 속합니다. 따라서 의사 테이블과 일정 테이블은 1:N (One-to-Many) 관계입니다.
- 한 건의 일정은 한 명의 환자에 연결될 수 있습니다 (수술, 진료의 경우). 따라서 환자 테이블과 일정 테이블은 1:N (One-to-Many) 관계입니다.
- 한 건의 일정은 한 건의 진단 결과와 연결될 수 있습니다 (X-Ray 검토의 경우). 따라서 진단 테이블과 일정 테이블은 1:1 (One-to-One) 관계입니다.

---

## 2. 객체 정의서

| 객체 명 | 속성 명 |
|---------|---------|
| **의사 (User)** | 의사 코드(PK), 의사 이름, 의사 로그인 이메일, 의사 비밀번호, 의사 소속 병원, 의사 소속 부서, 의사 면허번호, 의사 역할, 프로필 이미지 경로, 생성일시, 수정일시 |
| **환자 (Patient)** | 환자 코드(PK), 환자 이름, 환자 나이, 환자 성별, 병실 번호, 의무기록번호, 환자 상태, 담당 의사 코드(FK), 증상, 삭제 여부, 삭제일시, 생성일시, 수정일시 |
| **진단 결과 (Diagnosis)** | 진단 코드(PK), 환자 코드(FK), 의사 코드(FK), 이미지 파일 경로, AI 분석 결과(신뢰도, 발견 사항 배열, 권장 사항 배열, AI 노트, Grad-CAM 경로, Grad-CAM++ 경로, Layer-CAM 경로), 의사 검토 결과(요약, 소견, 검토 상태, 검토일시), 생성일시, 수정일시 |
| **일정 (Schedule)** | 일정 코드(PK), 일정 유형, 환자 코드(FK), 의사 코드(FK), 시작 일시, 종료 일시, 장소, 일정 상태, 상태 텍스트, 우선순위, 연결된 진단 코드(FK), 메모, 삭제 여부, 삭제일시, 생성일시, 수정일시 |

---

## 3. E-R Diagram

### 엔티티 및 속성

#### 1. 의사 (User)
- **의사 코드 (User ID)**: `ObjectId`, Primary Key (PK)
- **의사 이름 (Name)**: `String`, Required
- **의사 로그인 이메일 (Email)**: `String`, Required, Unique
- **의사 비밀번호 (Password)**: `String`, Required (Hashed)
- **의사 소속 병원 (Hospital)**: `String`, Optional
- **의사 소속 부서 (Department)**: `String`, Optional
- **의사 면허번호 (License Number)**: `String`, Optional
- **의사 역할 (Role)**: `enum['doctor', 'admin']`, Default: 'doctor'
- **프로필 이미지 경로 (Profile Image)**: `String`, Optional
- **생성일시 (Created At)**: `Date`, Auto
- **수정일시 (Updated At)**: `Date`, Auto

#### 2. 환자 (Patient)
- **환자 코드 (Patient ID)**: `ObjectId`, Primary Key (PK)
- **환자 이름 (Name)**: `String`, Required
- **환자 나이 (Age)**: `Number`, Optional
- **환자 성별 (Gender)**: `enum['남성', '여성', '기타']`, Default: '남성'
- **병실 번호 (Room Number)**: `String`, Optional
- **의무기록번호 (Medical Record Number)**: `String`, Optional
- **환자 상태 (Status)**: `enum['normal', 'pending', 'urgent']`, Default: 'normal'
- **담당 의사 코드 (Doctor ID)**: `ObjectId`, Foreign Key (FK), References: User
- **증상 (Symptoms)**: `String`, Optional
- **삭제 여부 (Is Deleted)**: `Boolean`, Default: false
- **삭제일시 (Deleted At)**: `Date`, Optional
- **생성일시 (Created At)**: `Date`, Auto
- **수정일시 (Updated At)**: `Date`, Auto

#### 3. 진단 결과 (Diagnosis)
- **진단 코드 (Diagnosis ID)**: `ObjectId`, Primary Key (PK)
- **환자 코드 (Patient ID)**: `ObjectId`, Foreign Key (FK), Required, References: Patient
- **의사 코드 (Doctor ID)**: `ObjectId`, Foreign Key (FK), Optional, References: User
- **이미지 파일 경로 (Image URL)**: `String`, Optional
- **AI 분석 결과 (AI Analysis)**: `Object`
  - **신뢰도 (Confidence)**: `Number`
  - **발견 사항 (Findings)**: `Array[Object]`
    - **질환명 (Condition)**: `String`
    - **확률 (Probability)**: `Number`
    - **설명 (Description)**: `String`
  - **권장 사항 (Recommendations)**: `Array[String]`
  - **AI 노트 (AI Notes)**: `String`
  - **Grad-CAM 이미지 경로 (GradCAM Path)**: `String`, Optional
  - **Grad-CAM++ 이미지 경로 (GradCAM Plus Path)**: `String`, Optional
  - **Layer-CAM 이미지 경로 (LayerCAM Path)**: `String`, Optional
- **의사 검토 결과 (Review)**: `Object`
  - **요약 (Summary)**: `String`, Optional
  - **소견 (Notes)**: `String`, Optional
  - **검토 상태 (Status)**: `enum['pending', 'approved', 'rejected']`, Default: 'pending'
  - **검토일시 (Updated At)**: `Date`, Optional
- **생성일시 (Created At)**: `Date`, Auto
- **수정일시 (Updated At)**: `Date`, Auto

#### 4. 일정 (Schedule)
- **일정 코드 (Schedule ID)**: `ObjectId`, Primary Key (PK)
- **일정 유형 (Type)**: `enum['surgery', 'appointment', 'xray', 'meeting', 'other']`, Required
- **환자 코드 (Patient ID)**: `ObjectId`, Foreign Key (FK), Conditional Required, References: Patient
- **의사 코드 (Doctor ID)**: `ObjectId`, Foreign Key (FK), Required, References: User
- **시작 일시 (Start Date Time)**: `Date`, Required
- **종료 일시 (End Date Time)**: `Date`, Required
- **장소 (Location)**: `String`, Default: ''
- **일정 상태 (Status)**: `enum['scheduled', 'completed', 'cancelled', 'in-progress']`, Default: 'scheduled'
- **상태 텍스트 (Status Text)**: `String`, Default: '예정'
- **우선순위 (Priority)**: `enum['low', 'medium', 'high', 'urgent']`, Default: 'medium'
- **연결된 진단 코드 (Linked Case ID)**: `ObjectId`, Foreign Key (FK), Optional, References: Diagnosis
- **메모 (Notes)**: `String`, Default: ''
- **삭제 여부 (Is Deleted)**: `Boolean`, Default: false
- **삭제일시 (Deleted At)**: `Date`, Optional
- **생성일시 (Created At)**: `Date`, Auto
- **수정일시 (Updated At)**: `Date`, Auto

---

### 관계 (Relationships)

#### 1. 의사 (User) ↔ 환자 (Patient)
- **관계 유형**: One-to-Many (1:N)
- **설명**: 한 명의 의사는 여러 명의 환자를 담당할 수 있습니다. 환자 테이블의 `doctorId` 필드가 의사 테이블의 `_id`를 참조합니다.
- **Crow's Foot 표기**: 의사 (1) ──< 환자 (N)

#### 2. 의사 (User) ↔ 진단 결과 (Diagnosis)
- **관계 유형**: One-to-Many (1:N)
- **설명**: 한 명의 의사는 여러 건의 진단 결과를 작성할 수 있습니다. 진단 테이블의 `doctorId` 필드가 의사 테이블의 `_id`를 참조합니다.
- **Crow's Foot 표기**: 의사 (1) ──< 진단 결과 (N)

#### 3. 의사 (User) ↔ 일정 (Schedule)
- **관계 유형**: One-to-Many (1:N)
- **설명**: 한 명의 의사는 여러 개의 일정을 가질 수 있습니다. 일정 테이블의 `doctorId` 필드가 의사 테이블의 `_id`를 참조합니다.
- **Crow's Foot 표기**: 의사 (1) ──< 일정 (N)

#### 4. 환자 (Patient) ↔ 진단 결과 (Diagnosis)
- **관계 유형**: One-to-Many (1:N)
- **설명**: 한 명의 환자는 여러 건의 진단 결과를 가질 수 있습니다. 진단 테이블의 `patientId` 필드가 환자 테이블의 `_id`를 참조합니다.
- **Crow's Foot 표기**: 환자 (1) ──< 진단 결과 (N)

#### 5. 환자 (Patient) ↔ 일정 (Schedule)
- **관계 유형**: One-to-Many (1:N)
- **설명**: 한 명의 환자는 여러 개의 일정을 가질 수 있습니다 (수술, 진료의 경우). 일정 테이블의 `patientId` 필드가 환자 테이블의 `_id`를 참조합니다. 단, 일정 유형이 'xray', 'meeting', 'other'인 경우 환자와 연결되지 않을 수 있습니다.
- **Crow's Foot 표기**: 환자 (1) ──< 일정 (N)

#### 6. 진단 결과 (Diagnosis) ↔ 일정 (Schedule)
- **관계 유형**: One-to-One (1:1)
- **설명**: 한 건의 진단 결과는 한 건의 일정과 연결될 수 있습니다 (X-Ray 검토 일정의 경우). 일정 테이블의 `linkedCaseId` 필드가 진단 테이블의 `_id`를 참조합니다.
- **Crow's Foot 표기**: 진단 결과 (1) ── 일정 (1)

---

## 4. 인덱스 설계

### 일정 테이블 (Schedule)
- **복합 인덱스 1**: `{ doctorId: 1, startDateTime: 1 }` - 의사별 일정 조회 성능 향상
- **인덱스 2**: `{ patientId: 1 }` - 환자별 일정 조회 성능 향상
- **복합 인덱스 3**: `{ startDateTime: 1, endDateTime: 1 }` - 날짜 범위 조회 성능 향상

### 의사 테이블 (User)
- **인덱스**: `{ email: 1 }` - Unique 인덱스 (로그인 시 이메일 검색 성능 향상)

---

## 5. 데이터 타입 및 제약사항

### 주요 데이터 타입
- **ObjectId**: MongoDB의 기본 키 타입 (24자리 16진수 문자열)
- **String**: 문자열 (길이 제한 없음, MongoDB 기본)
- **Number**: 숫자 (정수 또는 실수)
- **Date**: 날짜 및 시간
- **Boolean**: 불린 값 (true/false)
- **Array**: 배열
- **Object**: 중첩 객체

### 제약사항
- **필수 필드 (Required)**: 각 테이블의 Primary Key 및 필수 필드는 반드시 값이 있어야 합니다.
- **고유 제약 (Unique)**: 의사 테이블의 이메일은 고유해야 합니다.
- **열거형 제약 (Enum)**: 특정 필드는 미리 정의된 값만 허용합니다.
- **조건부 필수**: 일정 테이블의 `patientId`는 일정 유형에 따라 필수 또는 선택적입니다.
- **소프트 삭제**: 환자와 일정 테이블은 `isDeleted` 플래그를 사용하여 논리적 삭제를 지원합니다.

---

## 6. AI 모델 연동

### 진단 결과 테이블의 AI 분석 필드
- **모델 구조**: UNet (폐 영역 분할) + ResNet50 (COVID-19 분류)
- **분류 클래스**: 
  - COVID
  - Lung_Opacity
  - Normal
  - Viral Pneumonia
- **CAM 시각화**: Grad-CAM, Grad-CAM++, Layer-CAM 이미지 경로 저장
- **신뢰도**: 0.0 ~ 1.0 사이의 실수 값

---

**작성일**: 2025년 11월 25일  
**작성자**: 프로젝트 팀  
**버전**: 1.0
