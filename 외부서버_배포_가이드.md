# 🚀 외부 서버 배포 가이드 - AI 진단 기능 설정

## 📋 문제 상황

외부 서버(`210.125.70.71:31293`)에 배포 후 대시보드와 다른 기능은 정상 작동하지만, **AI 진단 기능만 작동하지 않는 문제**가 발생했습니다.

**오류 메시지**:
- 프론트엔드: "AI 진단 서비스를 사용할 수 없습니다. FastAPI 서버를 확인해주세요."
- 콘솔: `503 Service Unavailable` 또는 `400 Bad Request`

---

## 🔍 원인 분석

### 문제 1: 환경 변수 미설정
- Express 서버가 FastAPI 서버의 URL을 찾지 못함
- 프론트엔드가 Express/FastAPI 서버 URL을 찾지 못함

### 문제 2: 이미지 파일 경로 문제
- Express 서버와 FastAPI 서버가 서로 다른 파일 시스템 경로를 사용
- 상대 경로 사용으로 인한 파일 접근 실패

---

## ✅ 해결 방법 (단계별)

### 1단계: Express 백엔드 환경 변수 설정

**파일 위치**: `Final_Back/express/.env`

```bash
cd Final_Back/express
```

`.env` 파일을 생성하거나 수정:

```env
# MongoDB 연결
MONGODB_URI=mongodb+srv://username:password@cluster0.xxxxx.mongodb.net/medical-ai?retryWrites=true&w=majority

# JWT 시크릿
JWT_SECRET=your-super-secret-jwt-key-change-this-in-production

# Express 서버 포트
PORT=5001

# ⚠️ 중요: FastAPI 서버 URL 설정
# 같은 서버 내부에서 실행: http://localhost:8000
# 외부 서버에서 실행: http://210.125.70.71:8000
FASTAPI_URL=http://localhost:8000
```

**확인 사항**:
- Express 서버와 FastAPI 서버가 같은 서버에서 실행 중이면 `localhost` 사용 가능
- 다른 서버에서 실행 중이면 실제 IP 주소 사용

---

### 2단계: 프론트엔드 환경 변수 설정

**파일 위치**: `Final_Front4/.env`

```bash
cd Final_Front4
```

`.env` 파일을 생성:

```env
# Express 백엔드 API URL
# 로컬 개발: http://localhost:5001
# 외부 서버: http://210.125.70.71:5001
REACT_APP_API_BASE_URL=http://210.125.70.71:5001

# FastAPI 서버 URL (GradCAM 이미지 등 정적 파일 접근용)
# 로컬 개발: http://localhost:8000
# 외부 서버: http://210.125.70.71:8000
REACT_APP_FASTAPI_URL=http://210.125.70.71:8000
```

**⚠️ 중요**: 환경 변수 변경 후 **반드시 재빌드** 필요:

```bash
cd Final_Front4
npm run build
```

---

### 3단계: 코드 수정 확인

다음 파일들이 이미 수정되어 있어야 합니다:

#### ✅ Express 서버 (`Final_Back/express/src/controllers/diagnosisController.js`)
- 절대 경로 사용 (`path.resolve()`)
- 파일 존재 여부 확인
- 상세 로깅 추가

#### ✅ FastAPI 서버 (`Final_Back/fastapi/app/routers/ai.py`)
- 이미지 경로 상세 로깅
- 절대 경로 변환 로직

#### ✅ 프론트엔드 (`Final_Front4/src/utils/api.js`)
- 환경 변수 사용: `REACT_APP_API_BASE_URL`

#### ✅ 프론트엔드 (`Final_Front4/src/components/AIDiagnosis.js`)
- 환경 변수 사용: `REACT_APP_FASTAPI_URL`

---

### 4단계: 서버 재시작

#### Express 서버 재시작
```bash
cd Final_Back/express
# PM2 사용 시
pm2 restart express
# 또는 직접 실행
npm start
```

#### FastAPI 서버 재시작
```bash
cd Final_Back/fastapi
source venv/bin/activate  # 가상환경 활성화
uvicorn app.main:app --host 0.0.0.0 --port 8000
```

#### 프론트엔드 재빌드 (환경 변수 변경 시)
```bash
cd Final_Front4
npm run build
# 빌드된 파일을 웹 서버에 배포
```

---

## 🔍 문제 확인 방법

### 1. FastAPI 서버 연결 확인

```bash
# Express 서버에서 실행
curl http://210.125.70.71:8000
# 또는
curl http://210.125.70.71:8000/api/ai/health
```

**예상 응답**:
```json
{"message": "FastAPI AI 서비스가 실행 중입니다."}
```
또는
```json
{"status": "ok"}
```

### 2. Express 서버 로그 확인

진단 요청 시 다음 로그가 출력되어야 합니다:

```
FastAPI에 진단 요청 전송: {
  url: 'http://210.125.70.71:8000/api/ai/diagnose',
  image_path: '/절대경로/uploads/파일명',
  file_exists: true
}
```

### 3. FastAPI 서버 로그 확인

진단 요청 시 다음 로그가 출력되어야 합니다:

```
📁 이미지 경로 확인: /경로/uploads/파일명
   - 절대 경로: /절대경로/uploads/파일명
   - 존재 여부: true
   - 파일 여부: true
🚀 진단 요청 시작 - 이미지: /경로/uploads/파일명
```

---

## 🐛 문제 해결 체크리스트

### 오류: "AI 진단 서비스를 사용할 수 없습니다" (503)

- [ ] FastAPI 서버가 실행 중인가?
  ```bash
  curl http://210.125.70.71:8000
  ```

- [ ] Express 서버의 `.env`에 `FASTAPI_URL`이 올바르게 설정되었는가?
  ```env
  FASTAPI_URL=http://210.125.70.71:8000
  ```

- [ ] Express 서버를 재시작했는가?

- [ ] 네트워크 연결이 정상인가? (방화벽, 포트 열림)

### 오류: "이미지 파일을 찾을 수 없습니다" (400)

- [ ] Express 서버와 FastAPI 서버가 같은 서버에서 실행 중인가?

- [ ] Express 서버의 `uploads` 디렉토리가 존재하는가?
  ```bash
  ls -la Final_Back/express/src/uploads
  ```

- [ ] 이미지 파일이 실제로 업로드되었는가?
  ```bash
  ls -la Final_Back/express/src/uploads/
  ```

- [ ] Express 서버 로그에서 `file_exists: true`인가?

- [ ] FastAPI 서버 로그에서 이미지 경로를 확인했는가?

### 프론트엔드 연결 실패

- [ ] 프론트엔드 `.env` 파일이 생성되었는가?

- [ ] 환경 변수 값이 올바른가?
  ```env
  REACT_APP_API_BASE_URL=http://210.125.70.71:5001
  REACT_APP_FASTAPI_URL=http://210.125.70.71:8000
  ```

- [ ] 프론트엔드를 재빌드했는가?
  ```bash
  cd Final_Front4
  npm run build
  ```

- [ ] 브라우저 개발자 도구 → Network 탭에서 API 요청 확인

---

## 📝 외부 서버 배포 예시

서버 정보:
- **서버 IP**: `210.125.70.71`
- **Express 서버**: `210.125.70.71:5001`
- **FastAPI 서버**: `210.125.70.71:8000`
- **프론트엔드**: `210.125.70.71:31293`

### Express 백엔드 `.env`
```env
MONGODB_URI=mongodb+srv://...
JWT_SECRET=...
PORT=5001
FASTAPI_URL=http://localhost:8000  # 같은 서버 내부
# 또는
FASTAPI_URL=http://210.125.70.71:8000  # 외부 접근
```

### 프론트엔드 `.env`
```env
REACT_APP_API_BASE_URL=http://210.125.70.71:5001
REACT_APP_FASTAPI_URL=http://210.125.70.71:8000
```

---

## 🔧 추가 설정 (필요 시)

### CORS 설정

Express 서버가 이미 CORS를 허용하고 있습니다:
```javascript
// Final_Back/express/src/server.js
app.use(cors()); // 모든 origin 허용
```

FastAPI 서버에 CORS가 필요하면:
```python
# Final_Back/fastapi/app/main.py
from fastapi.middleware.cors import CORSMiddleware

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # 또는 특정 origin
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

### 파일 권한 설정

업로드 디렉토리 권한 확인:
```bash
chmod -R 755 Final_Back/express/src/uploads
```

---

## ✅ 최종 확인

1. **환경 변수 설정 완료**
   - [ ] Express `.env`에 `FASTAPI_URL` 설정
   - [ ] 프론트엔드 `.env`에 `REACT_APP_API_BASE_URL`, `REACT_APP_FASTAPI_URL` 설정

2. **서버 실행 확인**
   - [ ] Express 서버 실행 중
   - [ ] FastAPI 서버 실행 중
   - [ ] 프론트엔드 빌드 및 배포 완료

3. **기능 테스트**
   - [ ] 대시보드 접속 정상
   - [ ] AI 진단 페이지 접속 정상
   - [ ] 이미지 업로드 정상
   - [ ] 진단 요청 성공 (503/400 오류 없음)

---

## 📞 문제가 해결되지 않으면

1. **Express 서버 로그 확인**:
   ```bash
   # PM2 사용 시
   pm2 logs express
   # 또는 직접 실행 시 터미널 출력 확인
   ```

2. **FastAPI 서버 로그 확인**:
   ```bash
   # uvicorn 실행 시 터미널 출력 확인
   ```

3. **브라우저 개발자 도구 확인**:
   - Console 탭: JavaScript 오류
   - Network 탭: API 요청/응답 상태

4. **로그에서 다음 정보 확인**:
   - Express: `FastAPI에 진단 요청 전송:` 메시지
   - FastAPI: `📁 이미지 경로 확인:` 메시지
   - 오류 메시지 전체 내용

---

## 🎯 요약

**핵심 설정 3가지**:

1. **Express `.env`**: `FASTAPI_URL=http://localhost:8000` (또는 외부 IP)
2. **프론트엔드 `.env`**: `REACT_APP_API_BASE_URL`, `REACT_APP_FASTAPI_URL` 설정
3. **프론트엔드 재빌드**: 환경 변수 변경 후 `npm run build`

**서버 재시작**: 환경 변수 변경 후 모든 서버 재시작 필수!

